#!/bin/bash

THEMES_DIR="$HOME/.dotfiles/themes"
CURRENT_THEME_FILE="$HOME/.config/.current-theme"
DOTFILES="$HOME/.dotfiles"

# Function to apply theme
apply_theme() {
    THEME_NAME="$1"
    THEME_DIR="$THEMES_DIR/$THEME_NAME"

    if [ ! -d "$THEME_DIR" ]; then
        echo "Error: Theme '$THEME_NAME' not found"
        exit 1
    fi

    echo "Applying theme: $THEME_NAME"

    # 1. Update Hyprland source line
    if [ -f "$DOTFILES/hypr/.config/hypr/hyprland.conf" ]; then
        sed -i "s|source = ~/.dotfiles/themes/.*/hyprland.conf|source = ~/.dotfiles/themes/$THEME_NAME/hyprland.conf|" \
            "$DOTFILES/hypr/.config/hypr/hyprland.conf"
        echo "  ✓ Updated Hyprland config"
    fi

    # 2. Update Kitty include line
    if [ -f "$DOTFILES/kitty/.config/kitty/kitty.conf" ]; then
        sed -i "s|include ~/.dotfiles/themes/.*/kitty.conf|include ~/.dotfiles/themes/$THEME_NAME/kitty.conf|" \
            "$DOTFILES/kitty/.config/kitty/kitty.conf"
        echo "  ✓ Updated Kitty config"
    fi

    # 3. Copy Waybar CSS
    if [ -f "$THEME_DIR/waybar.css" ]; then
        cp "$THEME_DIR/waybar.css" "$DOTFILES/waybar/.config/waybar/style.css"
        echo "  ✓ Updated Waybar CSS"
    fi

    # 4. Copy Mako config
    if [ -f "$THEME_DIR/mako.conf" ]; then
        cp "$THEME_DIR/mako.conf" "$DOTFILES/mako/.config/mako/config"
        echo "  ✓ Updated Mako config"
    fi

    # 5. Copy Hyprlock config
    if [ -f "$THEME_DIR/hyprlock.conf" ]; then
        cp "$THEME_DIR/hyprlock.conf" "$DOTFILES/hypr/.config/hypr/hyprlock.conf"
        echo "  ✓ Updated Hyprlock config"
    fi

    # 6. Update Rofi theme
    if [ -f "$THEME_DIR/theme.json" ]; then
        ROFI_THEME=$(jq -r '.rofi_theme' "$THEME_DIR/theme.json")
        sed -i "s|@theme \".*\"|@theme \"$ROFI_THEME\"|" \
            "$DOTFILES/rofi/.config/rofi/config.rasi"
        echo "  ✓ Updated Rofi theme"
    fi

    # 6.5. Update Starship prompt
    if [ -f "$THEME_DIR/starship.toml" ]; then
        cp "$THEME_DIR/starship.toml" "$DOTFILES/starship/.config/starship.toml"
        echo "  ✓ Updated Starship prompt"
    fi

    # 7. Update Hyprpaper wallpapers
    update_wallpapers "$THEME_DIR"

    # 9. Reload services
    reload_services "$THEME_NAME"

    # 9. Save current theme
    echo "$THEME_NAME" > "$CURRENT_THEME_FILE"

    # 10. Send notification
    if [ -f "$THEME_DIR/theme.json" ]; then
        THEME_DISPLAY_NAME=$(jq -r '.name' "$THEME_DIR/theme.json")
        THEME_ICON=$(jq -r '.icon' "$THEME_DIR/theme.json")
        notify-send "Theme Switcher" "$THEME_ICON Theme applied: $THEME_DISPLAY_NAME" -i preferences-desktop-theme
    fi

    echo "Theme '$THEME_NAME' applied successfully!"
}

# Function to update wallpapers
update_wallpapers() {
    THEME_DIR="$1"
    HYPRPAPER_CONF="$DOTFILES/hypr/.config/hypr/hyprpaper.conf"

    if [ ! -f "$THEME_DIR/theme.json" ]; then
        echo "  ! Warning: theme.json not found, skipping wallpaper update"
        return
    fi

    # Clear existing config and rebuild
    cat > "$HYPRPAPER_CONF" << 'EOF'
# Auto-generated by theme-switcher
# preload static images
EOF

    # Get wallpaper paths from theme.json and add preloads
    jq -r '.wallpapers.static[]?' "$THEME_DIR/theme.json" 2>/dev/null | while read -r wp; do
        if [ -n "$wp" ]; then
            EXPANDED_PATH=$(eval echo "$wp")
            echo "preload = $EXPANDED_PATH" >> "$HYPRPAPER_CONF"
        fi
    done

    echo "" >> "$HYPRPAPER_CONF"
    echo "# set wallpapers for each monitor" >> "$HYPRPAPER_CONF"

    # Add monitor wallpaper assignments
    jq -r '.monitors | to_entries[] | "\(.key)=\(.value)"' "$THEME_DIR/theme.json" 2>/dev/null | while IFS='=' read -r monitor wp_ref; do
        # Parse reference like "static[0]"
        TYPE=$(echo "$wp_ref" | sed 's/\[.*//')
        INDEX=$(echo "$wp_ref" | grep -o '[0-9]*' | head -1)

        WALLPAPER=$(jq -r ".wallpapers.$TYPE[$INDEX]?" "$THEME_DIR/theme.json" 2>/dev/null)
        if [ -n "$WALLPAPER" ] && [ "$WALLPAPER" != "null" ]; then
            EXPANDED_PATH=$(eval echo "$WALLPAPER")
            echo "wallpaper = $monitor, $EXPANDED_PATH" >> "$HYPRPAPER_CONF"
        fi
    done

    echo "" >> "$HYPRPAPER_CONF"
    echo "# disable splash" >> "$HYPRPAPER_CONF"
    echo "splash = false" >> "$HYPRPAPER_CONF"

    echo "  ✓ Updated Hyprpaper config"
}

# Function to reload services
reload_services() {
    THEME_NAME="$1"
    echo "  → Reloading services..."

    # Reload Hyprland
    hyprctl reload &>/dev/null && echo "    ✓ Hyprland reloaded" || echo "    ! Hyprland reload failed"

    # Restart Hyprpaper
    killall hyprpaper &>/dev/null
    sleep 0.5
    hyprpaper &>/dev/null & disown
    echo "    ✓ Hyprpaper restarted"

    # Restart Waybar
    killall waybar &>/dev/null
    sleep 0.5
    waybar &>/dev/null & disown
    echo "    ✓ Waybar restarted"

    # Restart Mako
    killall mako &>/dev/null
    sleep 0.5
    mako &>/dev/null & disown
    echo "    ✓ Mako restarted"

    # Reload Kitty colors using remote control
    KITTY_THEME="$THEMES_DIR/$THEME_NAME/kitty.conf"
    if [ -f "$KITTY_THEME" ]; then
        # Try to reload colors in all kitty instances
        if command -v kitty &>/dev/null; then
            # Use kitty @ to set colors dynamically
            for pid in $(pgrep -x kitty); do
                kitty @ --to unix:/tmp/kitty-$pid set-colors --all --configured "$KITTY_THEME" &>/dev/null || true
            done
            echo "    ✓ Kitty colors updated (new terminals will use new colors)"
        fi
    fi
}

# Main execution
case "$1" in
    list)
        # List available themes
        echo "Available themes:"
        for theme in "$THEMES_DIR"/*; do
            if [ -d "$theme" ]; then
                THEME_SLUG=$(basename "$theme")
                if [ -f "$theme/theme.json" ]; then
                    ICON=$(jq -r '.icon' "$theme/theme.json")
                    NAME=$(jq -r '.name' "$theme/theme.json")
                    echo "  $ICON  $NAME ($THEME_SLUG)"
                else
                    echo "  • $THEME_SLUG"
                fi
            fi
        done
        ;;
    current)
        # Show current theme
        if [ -f "$CURRENT_THEME_FILE" ]; then
            CURRENT=$(cat "$CURRENT_THEME_FILE")
            THEME_DIR="$THEMES_DIR/$CURRENT"
            if [ -f "$THEME_DIR/theme.json" ]; then
                ICON=$(jq -r '.icon' "$THEME_DIR/theme.json")
                NAME=$(jq -r '.name' "$THEME_DIR/theme.json")
                echo "$ICON $NAME ($CURRENT)"
            else
                echo "$CURRENT"
            fi
        else
            echo "No theme set (default: osaka-jade)"
        fi
        ;;
    apply)
        # Apply specified theme
        if [ -z "$2" ]; then
            echo "Usage: theme-switcher.sh apply <theme-name>"
            exit 1
        fi
        apply_theme "$2"
        ;;
    *)
        echo "Usage: theme-switcher.sh {list|current|apply <theme-name>}"
        echo ""
        echo "Commands:"
        echo "  list              List all available themes"
        echo "  current           Show the currently active theme"
        echo "  apply <theme>     Apply a specific theme"
        exit 1
        ;;
esac
